# OH Emulator Manager

跨平台模拟器管理工具 - 可视化管理 iOS、Android、HarmonyOS 模拟器

---

## 一、项目背景

### 1.1 问题描述
软件测试工程师日常需要在 Windows、macOS 上频繁启动各类模拟器进行 App 测试：
- **iOS 模拟器**: 通过 `xcrun simctl` 命令行启动
- **Android 模拟器**: 通过 `emulator` 命令行启动
- **鸿蒙模拟器**: 通过 DevEco Studio 命令行工具启动

命令行操作繁琐、效率低下，缺乏统一的可视化管理界面。

### 1.2 解决方案
开发一款跨平台桌面应用，提供统一的可视化界面来管理和操作所有类型的模拟器。

---

## 二、需求规格

### 2.1 平台支持
| 平台 | 支持状态 | 最低版本 |
|------|---------|---------|
| Windows | ✅ | Windows 10+ |
| macOS | ✅ | macOS 11+ |
| Linux | ❌ | 暂不支持 |

### 2.2 模拟器支持范围

#### iOS 模拟器 (仅 macOS)
- **依赖**: Xcode 及其命令行工具
- **命令工具**: `xcrun simctl`
- **支持操作**: 列表查询、启动、关闭、删除、清除数据、截图、日志查看

#### Android 模拟器 (Windows/macOS)
- **依赖**: Android SDK (通过 Android Studio 或独立安装)
- **命令工具**: `emulator`, `adb`
- **支持操作**: 列表查询、启动、关闭、删除(冷删除AVD)、清除数据(wipe-data)、截图、日志查看

#### HarmonyOS NEXT 模拟器 (Windows/macOS)
- **依赖**: DevEco Studio 5.x+
- **命令工具**: `hdctool`, `hdc`
- **支持操作**: 列表查询、启动、关闭、截图、日志查看
- **注意**: 仅支持 HarmonyOS NEXT，不支持旧版 HarmonyOS 4.x

### 2.3 环境配置
应用需要知道各 SDK 的安装路径，获取优先级：
1. **用户配置**: 应用内设置界面手动配置
2. **环境变量**: 自动读取系统环境变量
3. **默认路径**: 检测常见安装路径

| 配置项 | 环境变量 | 默认路径示例 |
|-------|---------|-------------|
| Android SDK | `ANDROID_HOME` / `ANDROID_SDK_ROOT` | Windows: `%LOCALAPPDATA%\Android\Sdk`<br>macOS: `~/Library/Android/sdk` |
| DevEco Studio | `DEVECO_SDK_HOME` | Windows: `%LOCALAPPDATA%\Huawei\DevEcoStudio`<br>macOS: `~/Library/Huawei/DevEcoStudio` |
| Xcode | - | `/Applications/Xcode.app` (自动检测) |

---

## 三、功能详细设计

### 3.1 主界面

#### 3.1.1 标签页结构
- **iOS 模拟器** (仅 macOS 显示)
- **Android 模拟器**
- **HarmonyOS 模拟器**

#### 3.1.2 模拟器列表
每个模拟器项显示：
- 模拟器图标/缩略图
- 名称
- 设备类型 (如 iPhone 15, Pixel 7)
- 系统版本
- 运行状态 (运行中/已停止)
- 唯一标识符 (UDID/AVD Name)

#### 3.1.3 模拟器操作
| 操作 | 说明 | iOS | Android | HarmonyOS |
|------|------|-----|---------|-----------|
| 拷贝 ID | 复制模拟器唯一标识到剪贴板 | ✅ | ✅ | ✅ |
| 启动 | 启动模拟器 | ✅ | ✅ | ✅ |
| 关闭 | 关闭运行中的模拟器 | ✅ | ✅ | ✅ |
| 删除 | 删除模拟器 | ✅ | ✅ | ❌ |
| 清除数据 | 恢复出厂设置 | ✅ | ✅ | ❌ |
| 截图 | 对模拟器屏幕截图并保存 | ✅ | ✅ | ✅ |
| 查看日志 | 按包名过滤查看应用日志 | ✅ | ✅ | ✅ |

#### 3.1.4 工具栏
- 刷新按钮: 手动刷新模拟器列表
- 搜索框: 按名称过滤模拟器

### 3.2 设置界面

#### 3.2.1 通用设置
| 设置项 | 类型 | 选项 | 默认值 |
|-------|------|------|--------|
| 界面语言 | 下拉选择 | 中文、English | 跟随系统 |
| 主题模式 | 下拉选择 | 浅色、深色、跟随系统 | 跟随系统 |
| 开机自启 | 开关 | 开/关 | 关 |
| 最小化到托盘 | 开关 | 开/关 | 开 |
| 关闭时最小化 | 开关 | 开/关 | 开 |

#### 3.2.2 路径配置
| 配置项 | 输入方式 | 验证 |
|-------|---------|------|
| ANDROID_HOME | 文件夹选择器 | 检查 `emulator` 命令是否存在 |
| DEVECO_SDK_HOME | 文件夹选择器 | 检查 `hdctool` 命令是否存在 |

### 3.3 系统托盘 / 菜单栏

#### Windows 系统托盘
- 左键单击: 显示/隐藏主窗口
- 右键菜单:
  - 显示主窗口
  - 快速启动 (最近使用的模拟器列表)
  - 设置
  - 退出

#### macOS 菜单栏
- 点击图标显示下拉菜单:
  - 模拟器快速启动列表
  - 显示主窗口
  - 设置
  - 退出

---

## 四、技术设计方案

### 4.1 技术栈

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 框架 | Tauri 2.x | Rust 后端，原生 WebView 渲染 |
| 前端 | Vue 3 + TypeScript | Composition API |
| UI 组件库 | Naive UI / Element Plus | 现代化设计风格 |
| 状态管理 | Pinia | Vue 官方状态管理 |
| 构建工具 | Vite | 快速开发构建 |
| 数据存储 | SQLite (rusqlite) | 本地持久化 |
| 样式 | UnoCSS / Tailwind CSS | 原子化 CSS |

### 4.2 项目结构

```
oh-emulator-manager/
├── src/                      # 前端源码
│   ├── assets/               # 静态资源
│   ├── components/           # 通用组件
│   │   ├── EmulatorCard.vue  # 模拟器卡片
│   │   ├── EmulatorList.vue  # 模拟器列表
│   │   └── LogViewer.vue     # 日志查看器
│   ├── views/                # 页面视图
│   │   ├── HomeView.vue      # 主页 (标签页)
│   │   └── SettingsView.vue  # 设置页
│   ├── stores/               # Pinia 状态
│   │   ├── emulator.ts       # 模拟器状态
│   │   └── settings.ts       # 设置状态
│   ├── i18n/                 # 国际化
│   │   ├── zh-CN.json
│   │   └── en-US.json
│   ├── App.vue
│   └── main.ts
├── src-tauri/                # Tauri/Rust 后端
│   ├── src/
│   │   ├── main.rs           # 入口
│   │   ├── commands/         # Tauri 命令
│   │   │   ├── ios.rs        # iOS 模拟器操作
│   │   │   ├── android.rs    # Android 模拟器操作
│   │   │   ├── harmony.rs    # 鸿蒙模拟器操作
│   │   │   └── settings.rs   # 设置操作
│   │   ├── db/               # 数据库
│   │   │   ├── mod.rs
│   │   │   └── schema.rs
│   │   ├── watcher/          # 文件监听
│   │   │   └── mod.rs
│   │   └── tray.rs           # 系统托盘
│   ├── Cargo.toml
│   └── tauri.conf.json
├── _docs/                    # 项目文档
├── package.json
└── vite.config.ts
```

### 4.3 数据库设计

#### emulators 表
```sql
CREATE TABLE emulators (
    id TEXT PRIMARY KEY,           -- 模拟器唯一标识
    type TEXT NOT NULL,            -- ios/android/harmony
    name TEXT NOT NULL,            -- 显示名称
    device_type TEXT,              -- 设备类型
    os_version TEXT,               -- 系统版本
    status TEXT DEFAULT 'stopped', -- running/stopped
    last_used_at INTEGER,          -- 最后使用时间戳
    created_at INTEGER NOT NULL,   -- 创建时间
    updated_at INTEGER NOT NULL    -- 更新时间
);
```

#### settings 表
```sql
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL
);
```

### 4.4 模拟器操作实现

#### iOS (xcrun simctl)
```bash
# 列表
xcrun simctl list devices --json

# 启动
xcrun simctl boot <udid>
open -a Simulator --args -CurrentDeviceUDID <udid>

# 关闭
xcrun simctl shutdown <udid>

# 删除
xcrun simctl delete <udid>

# 清除数据
xcrun simctl erase <udid>

# 截图
xcrun simctl io <udid> screenshot <output_path>

# 日志
xcrun simctl spawn <udid> log stream --predicate 'subsystem == "<bundle_id>"'
```

#### Android (emulator/adb)
```bash
# 列表
emulator -list-avds
adb devices  # 获取运行中的

# 启动
emulator -avd <avd_name>

# 关闭
adb -s <serial> emu kill

# 清除数据
emulator -avd <avd_name> -wipe-data

# 截图
adb -s <serial> exec-out screencap -p > <output_path>

# 日志
adb -s <serial> logcat --pid=$(adb -s <serial> shell pidof <package_name>)
```

#### HarmonyOS NEXT (hdctool/hdc)
```bash
# 列表
hdctool list targets

# 启动
hdctool start <device_name>

# 关闭
hdctool stop <device_name>

# 截图
hdc -t <serial> shell snapshot_display -f /data/local/tmp/screenshot.png
hdc -t <serial> file recv /data/local/tmp/screenshot.png <local_path>

# 日志
hdc -t <serial> hilog | grep <bundle_name>
```

### 4.5 文件监听方案

使用 `notify` crate 监听模拟器相关目录变化：

| 平台 | 监听目录 |
|-----|---------|
| iOS | `~/Library/Developer/CoreSimulator/Devices/` |
| Android | `~/.android/avd/` |
| HarmonyOS | DevEco 模拟器配置目录 (待确认具体路径) |

当检测到变化时，触发模拟器列表刷新并更新数据库。

**可行性评估**:
- iOS/Android 目录监听可行
- HarmonyOS 需要进一步调研 DevEco Studio 的模拟器存储路径

---

## 五、UI 设计规范

### 5.1 设计风格
- 参考图片: `UI.jpg`
- 风格: 现代简洁、卡片式布局
- 颜色: 支持深色/浅色主题

### 5.2 布局结构
```
┌─────────────────────────────────────────────┐
│ Logo   [设置]  [版本信息]                      │
├─────────────────────────────────────────────┤
│ [iOS] [Android] [HarmonyOS]    [刷新] [+]   │
├─────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────┐ │
│ │ ⋮⋮  [图标]  模拟器名称                    │ │
│ │            设备类型 · 系统版本            │ │
│ │            [运行中]                      │ │
│ │                    [启动] [更多▼]        │ │
│ └─────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────┐ │
│ │ ⋮⋮  [图标]  模拟器名称                    │ │
│ │            设备类型 · 系统版本            │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

---

## 六、开发里程碑

### Phase 1: 基础框架
- [ ] 项目初始化 (Tauri + Vue 3)
- [ ] 基础 UI 框架搭建
- [ ] 设置页面实现
- [ ] 国际化支持
- [ ] 主题切换

### Phase 2: Android 模拟器
- [ ] Android 模拟器列表获取
- [ ] 启动/关闭功能
- [ ] 删除/清除数据
- [ ] 截图功能
- [ ] 日志查看

### Phase 3: iOS 模拟器 (macOS)
- [ ] iOS 模拟器列表获取
- [ ] 全部操作功能实现

### Phase 4: HarmonyOS 模拟器
- [ ] HarmonyOS NEXT 模拟器支持
- [ ] 调研 DevEco 命令行工具

### Phase 5: 系统集成
- [ ] 系统托盘/菜单栏
- [ ] 开机自启
- [ ] 文件监听自动刷新
- [ ] SQLite 持久化

### Phase 6: 优化发布
- [ ] 性能优化
- [ ] 打包发布 (Windows/macOS)
